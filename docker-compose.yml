services:
  py-captions:
    build: .
    image: py-captions-for-channels:latest
    container_name: py-captions-for-channels
    restart: unless-stopped
    runtime: nvidia
    
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      # Set container timezone (recommended for local timestamp display)
      - TZ=${TZ:-}
      # Explicit server timezone used by app for formatting
      - SERVER_TZ=${SERVER_TZ:-}
      - USE_MOCK=${USE_MOCK:-false}
      - USE_POLLING=${USE_POLLING:-false}
      - USE_WEBHOOK=${USE_WEBHOOK:-true}
      - WEBHOOK_HOST=${WEBHOOK_HOST:-0.0.0.0}
      - WEBHOOK_PORT=${WEBHOOK_PORT:-9000}
      - WEB_UI_PORT=${WEB_UI_PORT:-8000}
      - CHANNELS_API_URL=${CHANNELS_API_URL:-http://localhost:8089}
      - CHANNELWATCH_URL=${CHANNELWATCH_URL:-ws://localhost:8501/events}
      - API_TIMEOUT=${API_TIMEOUT:-10}
      
      # Caption processing options
      - TRANSCODE_FOR_FIRETV=${TRANSCODE_FOR_FIRETV:-false}
      - KEEP_ORIGINAL=${KEEP_ORIGINAL:-true}
      - CAPTION_COMMAND=${CAPTION_COMMAND:-}
      
      # Data storage — all persistent data lives under DATA_DIR inside the
      # container (/app/data by default).  The volume mount below controls
      # where that maps on the host.  Individual paths can still be overridden.
      - DATA_DIR=${DATA_DIR:-/app/data}
      - DRY_RUN=${DRY_RUN:-false}
      - PIPELINE_TIMEOUT=${PIPELINE_TIMEOUT:-7200}
      - STALE_EXECUTION_SECONDS=${STALE_EXECUTION_SECONDS:-7200}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_VERBOSITY=${LOG_VERBOSITY:-NORMAL}
    
    volumes:
      # Host data directory → container /app/data
      # Change the left side to point to a volume with ample disk space.
      # Example: /tank/py-captions:/app/data
      - ${HOST_DATA_DIR:-./data}:/app/data
      - ./py_captions_for_channels:/app/py_captions_for_channels
      - ./.env:/app/.env
      - /tank/AllMedia/Channels:/tank/AllMedia/Channels:rw
    ports:
      - "${WEBHOOK_PORT:-9000}:${WEBHOOK_PORT:-9000}"
      - "${WEB_UI_PORT:-8000}:${WEB_UI_PORT:-8000}"
      - "61208:61208"  # Glances web UI (legacy, may be removed)
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"