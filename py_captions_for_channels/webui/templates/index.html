<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Py Captions Dashboard</title>
  <link rel="icon" type="image/png" sizes="16x16" href="/static/channels_cc_favicon_big/icon-16.png?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/channels_cc_favicon_big/icon-32.png?v=3">
  <link rel="icon" type="image/png" sizes="48x48" href="/static/channels_cc_favicon_big/icon-48.png?v=3">
  <link rel="icon" type="image/x-icon" href="/static/channels_cc_favicon_big/favicon.ico?v=3">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/channels_cc_favicon_big/icon-180.png">
  <link rel="manifest" href="/static/channels_cc_favicon_big/site.webmanifest" />
  <link rel="stylesheet" href="/static/style.css?v=20260216-2" />
  <link rel="stylesheet" href="/static/vendor/uplot.min.css" />
</head>
<body>
  <!-- Compact navigation bar -->
  <nav class="navbar">
    <!-- Logo and Title -->
    <div class="navbar-brand">
      <img src="/static/channels_cc_favicon_big/icon-48.png" alt="Py Captions" class="navbar-logo" />
      <div class="navbar-title">
        <div class="navbar-app-name">Py Captions</div>
        <div class="navbar-version" id="webui-version-nav">v0.9.0</div>
      </div>
    </div>

    <!-- Services Section -->
    <div class="navbar-section navbar-services">
      <div class="navbar-section-label">Services</div>
      <div id="services" class="navbar-items">
        <div class="navbar-service"><span class="service-unhealthy">●</span> Checking...</div>
      </div>
    </div>

    <!-- Heartbeat Section -->
    <div class="navbar-section navbar-heartbeat">
      <div class="navbar-section-label">Heartbeat</div>
      <div class="navbar-items">
        <div class="navbar-heartbeat-item">
          <span id="heartbeat-polling" class="heartbeat-indicator" title="API Polling">●</span>
          <span class="navbar-heartbeat-label">Polling</span>
        </div>
        <div class="navbar-heartbeat-item">
          <span id="heartbeat-manual" class="heartbeat-indicator" title="Manual Queue">●</span>
          <span class="navbar-heartbeat-label">Manual</span>
        </div>
      </div>
    </div>

    <!-- Process Indicators Section -->
    <div class="navbar-section navbar-processes">
      <div class="navbar-section-label">Processing</div>
      <div id="processes" class="navbar-items navbar-process-items">
        <div class="navbar-service"><span class="service-unhealthy">●</span> Checking...</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="navbar-actions">
      <button class="navbar-btn" onclick="showManualProcessModal()" title="Browse and select recordings">
        <span class="navbar-btn-icon">☑</span>
        <span class="navbar-btn-label">Recordings</span>
      </button>
      <button class="navbar-btn" onclick="openSettingsModal()" title="Settings">
        <span class="navbar-btn-icon">⚙</span>
      </button>
    </div>
  </nav>

  <main class="main-content">
    <section class="card">
      <div class="card-head">
        <h2>Pipeline Activity</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('executions')">Executions</button>
          <button class="tab-btn" onclick="switchTab('logs')">Full Logs</button>
          <button class="tab-btn" onclick="switchTab('glances')">System Monitor</button>
        </div>
      </div>
      
      <div id="executions-tab" class="tab-content active">
        <div class="tab-header">
          <small class="muted" id="exec-count">(loading)</small>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button class="btn-small" onclick="clearList()">Clear List</button>
            <button class="btn-small" onclick="clearPollingCache()" title="Clear polling cache to allow reprocessing recordings">Reset Cache</button>
          </div>
        </div>
        <div class="exec-section">
          <div class="exec-section-title">Active</div>
          <ul class="exec-list exec-list-compact" id="exec-list-active">
            <li class="muted">Loading executions...</li>
          </ul>
        </div>
        <div class="exec-section">
          <div class="exec-section-title">Queue</div>
          <ul class="exec-list" id="exec-list-backlog">
            <li class="muted">Loading executions...</li>
          </ul>
        </div>
      </div>
      
      <div id="logs-tab" class="tab-content">
        <div class="tab-header">
          <small class="muted" id="log-count">(loading)</small>
        </div>
        <ul class="log-list" id="log-list">
          <li class="muted">Loading logs...</li>
        </ul>
      </div>

      <div id="glances-tab" class="tab-content">
        <div class="tab-header">
          <small class="muted">Real-time system and pipeline monitoring</small>
        </div>
        
        <!-- Pipeline Status Panel -->
        <div id="pipeline-status" class="monitor-panel" style="margin-bottom: 20px;">
          <h3>Pipeline Status</h3>
          <div id="pipeline-info" class="pipeline-info">
            <div class="pipeline-idle">No active pipeline</div>
          </div>
        </div>

        <!-- System Metrics Charts -->
        <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-title">CPU Usage</div>
            <div class="chart-wrapper">
              <div id="chart-cpu" class="chart"></div>
            </div>
          </div>
          <div class="chart-container" id="gpu-chart-container" style="display: none;">
            <div class="chart-title">GPU</div>
            <div class="chart-wrapper">
              <div id="chart-gpu" class="chart"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Disk I/O</div>
            <div class="chart-wrapper">
              <div id="chart-disk" class="chart"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Network</div>
            <div class="chart-wrapper">
              <div id="chart-network" class="chart"></div>
            </div>
          </div>
        </div>
        
        <div id="gpu-unavailable" class="monitor-panel" style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; text-align: center; color: #888;">
          Checking GPU availability...
        </div>
      </div>
    </section>

  </main>

  <!-- Modal for execution details -->
    <div id="exec-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Execution Details</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
          <p class="muted">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Modal for manual processing -->
    <div id="manual-process-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Manual Processing</h2>
          <button class="modal-close" onclick="closeManualProcessModal()">&times;</button>
        </div>
        <div class="modal-body">
           <div class="manual-process-controls">
             <p class="muted">Browse recordings from Channels DVR and select items to process:</p>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
               <div class="settings-group">
                 <label for="manual-process-skip-caption">Skip Caption Generation</label>
                 <input type="checkbox" id="manual-process-skip-caption" name="skip_caption_generation">
               </div>
               <div class="settings-group">
                 <label for="manual-process-log-verbosity">Log Verbosity</label>
                 <select id="manual-process-log-verbosity" name="log_verbosity">
                   <option value="MINIMAL">Minimal</option>
                   <option value="NORMAL" selected>Normal</option>
                   <option value="VERBOSE">Verbose</option>
                 </select>
               </div>
             </div>
             <p class="muted" style="font-size: 0.9em; margin-top: -5px;">These settings will apply to all selected items.</p>
           </div>
          <div id="manual-process-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <p class="muted">Loading candidates...</p>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button onclick="closeManualProcessModal()" class="btn-secondary">Cancel</button>
            <button onclick="submitManualProcessing()" class="btn-primary">Add Selected to Queue</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for settings -->
    <div id="settings-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <h2>Pipeline Settings</h2>
            <span id="webui-version" class="pill pill-muted">v—</span>
          </div>
          <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- Status Information Section -->
          <div class="settings-status-section">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: var(--muted);">System Status</h3>
            <div class="settings-status-grid">
              <div class="settings-status-item">
                <span class="settings-status-label">Application:</span>
                <span class="settings-status-value"><span id="app-name">—</span> v<span id="app-version">—</span></span>
              </div>
              <div class="settings-status-item">
                <span class="settings-status-label">Timezone:</span>
                <span class="settings-status-value" id="timezone">—</span>
              </div>
              <div class="settings-status-item">
                <span class="settings-status-label">Last Processed:</span>
                <span class="settings-status-value" id="last-processed">—</span>
              </div>
              <div class="settings-status-item">
                <span class="settings-status-label">Queue Size:</span>
                <span class="settings-status-value" id="modal-queue-size">—</span>
              </div>
            </div>
          </div>
          
          <hr style="border: none; border-top: 1px solid var(--panel-border); margin: 20px 0;">
          
          <h3 style="margin: 0 0 16px 0; font-size: 14px; color: var(--muted);">Configuration</h3>
          <form id="settings-form" onsubmit="saveSettings(event)">
            <div class="settings-group">
              <label for="discovery-mode-select">Discovery Mode</label>
              <select id="discovery-mode-select" name="discovery_mode">
                <option value="polling">Channels API Polling</option>
                <option value="webhook">ChannelWatch Webhook</option>
                <option value="mock">Mock Source</option>
              </select>
            </div>
            <div class="settings-group">
              <label for="dry-run-toggle">Dry Run</label>
              <input type="checkbox" id="dry-run-toggle" name="dry_run">
            </div>
            <div class="settings-group">
              <label for="keep-original-toggle">Keep Original</label>
              <input type="checkbox" id="keep-original-toggle" name="keep_original">
            </div>
            <div class="settings-group">
              <label for="log-verbosity-select">Log Verbosity</label>
              <select id="log-verbosity-select" name="log_verbosity">
                <option value="MINIMAL">Minimal</option>
                <option value="NORMAL">Normal</option>
                <option value="VERBOSE">Verbose</option>
              </select>
            </div>
            <div class="settings-group">
              <label for="whisper-model-select">Whisper Model</label>
              <select id="whisper-model-select" name="whisper_model">
                <option value="tiny">tiny (fastest, least accurate)</option>
                <option value="tiny.en">tiny.en (English-only, faster)</option>
                <option value="base">base (good speed/accuracy)</option>
                <option value="base.en">base.en (English-only, recommended)</option>
                <option value="small">small (balanced)</option>
                <option value="small.en">small.en (English-only)</option>
                <option value="medium">medium (slower, more accurate)</option>
                <option value="medium.en">medium.en (English-only)</option>
                <option value="large-v1">large-v1 (original large)</option>
                <option value="large-v2">large-v2 (improved)</option>
                <option value="large-v3">large-v3 (latest, best accuracy)</option>
                <option value="large">large (alias for large-v3)</option>
              </select>
            </div>
            <div class="settings-group">
              <label for="whitelist-editor">Whitelist</label>
              <textarea id="whitelist-editor" name="whitelist" rows="8" style="width:100%"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
              <button type="button" class="btn-secondary" onclick="closeSettingsModal()">Cancel</button>
              <button type="submit" class="btn-primary">Save Settings</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  <script src="/static/vendor/uplot.min.js"></script>
  <script src="/static/main.js?v=20260216-2"></script>
</body>
</html>
