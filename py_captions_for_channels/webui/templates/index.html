<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Py Captions Dashboard</title>
  <link rel="icon" type="image/png" sizes="16x16" href="/static/channels_cc_favicon_big/icon-16.png?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/channels_cc_favicon_big/icon-32.png?v=3">
  <link rel="icon" type="image/png" sizes="48x48" href="/static/channels_cc_favicon_big/icon-48.png?v=3">
  <link rel="icon" type="image/x-icon" href="/static/channels_cc_favicon_big/favicon.ico?v=3">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/channels_cc_favicon_big/icon-180.png">
  <link rel="manifest" href="/static/channels_cc_favicon_big/site.webmanifest" />
  <link rel="stylesheet" href="/static/style.css?v=1772200000" />
  <link rel="stylesheet" href="/static/vendor/uplot.min.css" />
</head>
<body>
  <!-- Compact navigation bar -->
  <nav class="navbar">
    <!-- Logo and Title -->
    <div class="navbar-brand">
      <img src="/static/channels_cc_favicon_big/icon-48.png" alt="Py Captions" class="navbar-logo" />
      <div class="navbar-title">
        <div class="navbar-app-name">Py Captions</div>
        <div class="navbar-version" id="webui-version-nav">v0.9.0</div>
      </div>
    </div>

    <!-- Services Section -->
    <div class="navbar-section navbar-services">
      <div class="navbar-section-label">Services</div>
      <div id="services" class="navbar-items">
        <div class="navbar-service"><span class="service-unhealthy">●</span> Checking...</div>
      </div>
    </div>

    <!-- Polling Section -->
    <div class="navbar-section navbar-heartbeat">
      <div class="navbar-section-label">Polling</div>
      <div class="navbar-items">
        <div class="navbar-heartbeat-item">
          <span id="heartbeat-polling" class="heartbeat-indicator" title="Polling Activity">●</span>
        </div>
      </div>
    </div>

    <!-- Process Indicators Section -->
    <div class="navbar-section navbar-processes">
      <div class="navbar-section-label">Processing</div>
      <div id="processes" class="navbar-items navbar-process-items">
        <div class="navbar-service"><span class="service-unhealthy">●</span> Checking...</div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="navbar-actions">
      <button class="navbar-btn" onclick="showManualProcessModal()" title="Browse and select recordings">
        <span class="navbar-btn-icon">☑</span>
        <span class="navbar-btn-label">Recordings</span>
      </button>
      <button class="navbar-btn" onclick="openSettingsModal()" title="Settings">
        <span class="navbar-btn-icon">⚙</span>
      </button>
    </div>
  </nav>

  <main class="main-content">
    <section class="card">
      <div class="card-head">
        <h2>Job Activity</h2>
        <div class="tabs">
          <button class="tab-btn active" onclick="switchTab('executions')">Jobs</button>
          <button class="tab-btn" onclick="switchTab('glances')">System Monitor</button>
          <button class="tab-btn" onclick="switchTab('logs')">Full Logs</button>
          <button class="tab-btn" onclick="switchTab('quarantine')">Quarantine</button>
          <button class="tab-btn" id="channels-files-tab-btn" onclick="switchTab('channels-files')" style="display:none">Channels Files</button>
        </div>
      </div>
      
      <div id="executions-tab" class="tab-content active">
        <div class="tab-fixed-top">
          <div class="tab-header">
            <small class="muted" id="exec-count">(loading)</small>
            <div style="margin-left:auto; display:flex; gap:8px;">
              <button class="btn-small" onclick="clearList()">Clear List</button>
              <button class="btn-small" onclick="clearPollingCache()" title="Clear polling cache to allow reprocessing recordings">Reset Cache</button>
            </div>
          </div>
          <div class="exec-section">
            <div class="exec-section-title">Queue</div>
            <ul class="exec-list exec-list-compact" id="exec-list-queue">
              <li class="muted">Loading...</li>
            </ul>
          </div>
        </div>
        <div class="exec-section-title" style="margin-bottom:8px;">History</div>
        <div class="tab-scrollable">
          <div class="exec-section">
            <ul class="exec-list" id="exec-list-history">
              <li class="muted">Loading...</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div id="logs-tab" class="tab-content">
        <div class="tab-header">
          <small class="muted" id="log-count">(loading)</small>
        </div>
        <ul class="log-list" id="log-list">
          <li class="muted">Loading logs...</li>
        </ul>
      </div>

      <div id="glances-tab" class="tab-content">
        <div class="tab-fixed-top">
          <div class="tab-header">
            <small class="muted" id="pipeline-activity-indicator" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;">Real-time system and pipeline monitoring</small>
          </div>
          
          <!-- Pipeline Flow Visualization -->
          <div id="pipeline-status" class="monitor-panel pipeline-panel" style="margin-bottom: 10px;">
            <div id="pipeline-info" class="pipeline-flow">
              <div class="pipeline-info-text">No active pipeline</div>
            </div>
          </div>
        </div>

        <!-- System Metrics Charts -->
        <div class="tab-scrollable">
          <div class="charts-grid">
          <div class="chart-container">
            <div class="chart-title">CPU Usage</div>
            <div class="chart-wrapper">
              <div id="chart-cpu" class="chart"></div>
            </div>
          </div>
          <div class="chart-container" id="gpu-chart-container" style="display: none;">
            <div class="chart-title">GPU</div>
            <div class="chart-wrapper">
              <div id="chart-gpu" class="chart"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Disk I/O</div>
            <div class="chart-wrapper">
              <div id="chart-disk" class="chart"></div>
            </div>
          </div>
          <div class="chart-container">
            <div class="chart-title">Network</div>
            <div class="chart-wrapper">
              <div id="chart-network" class="chart"></div>
            </div>
          </div>
          </div>
          
          <div id="gpu-unavailable" class="monitor-panel" style="margin-top: 20px; padding: 15px; background: #2a2a2a; border-radius: 8px; text-align: center; color: #888;">
            Checking GPU availability...
          </div>
        </div>
      </div>

      <div id="quarantine-tab" class="tab-content">
        <div class="tab-header">
          <small class="muted" id="quarantine-stats">(loading)</small>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button class="btn-small" onclick="scanForOrphans()">Scan (History)</button>
            <button class="btn-small" onclick="deepScanForOrphans()">Deep Scan (Filesystem)</button>
            <button class="btn-small" onclick="dedupQuarantine()">Dedup</button>
            <button class="btn-small" onclick="restoreSelected()">Restore Selected</button>
            <button class="btn-small btn-danger" onclick="deleteSelected()">Delete Selected</button>
          </div>
        </div>
        
        <!-- Scan Paths Management -->
        <div class="scan-paths-section" style="padding: 10px; margin-bottom: 10px; background: #2a2a2a; border-radius: 4px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h3 style="margin: 0; font-size: 0.95em; color: #aaa;">Deep Scan Paths</h3>
            <button class="btn-small" onclick="toggleScanPathsManager()" id="toggle-scan-paths-btn">Configure</button>
          </div>
          <div id="scan-paths-manager" style="display: none;">
            <div style="margin-bottom: 10px;">
              <p style="margin: 0 0 10px 0; color: #888; font-size: 0.85em;">
                Configure folder paths for deep filesystem scanning. Useful for files moved from Channels DVR storage or custom library structures.
              </p>
              <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <input type="text" id="new-scan-path" placeholder="/path/to/media" style="flex: 1; padding: 6px; background: #1a1a1a; border: 1px solid #444; border-radius: 3px; color: #fff;">
                <input type="text" id="new-scan-label" placeholder="Label (optional)" style="width: 150px; padding: 6px; background: #1a1a1a; border: 1px solid #444; border-radius: 3px; color: #fff;">
                <button class="btn-small" onclick="addScanPath()">Add Path</button>
              </div>
            </div>
            <div id="scan-paths-list" style="max-height: 200px; overflow-y: auto;">
              <p style="color: #666; font-size: 0.85em;">Loading scan paths...</p>
            </div>

            <!-- Filesystem topology analysis -->
            <div id="fs-analysis" style="margin-top: 12px; padding: 10px; background: #1a1a1a; border-radius: 4px; border: 1px solid #333;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <h4 style="margin: 0; font-size: 0.85em; color: #aaa;">Filesystem Topology</h4>
                <button class="btn-small" onclick="loadFilesystemAnalysis()">Refresh</button>
              </div>
              <div id="fs-analysis-content" style="font-size: 0.8em; color: #888;">
                <p style="margin: 0;">Click Refresh to analyse filesystem layout.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="quarantine-info" style="padding: 10px; margin-bottom: 10px; background: #2a2a2a; border-radius: 4px;">
          <p style="margin: 0 0 8px 0; color: #888; font-size: 0.9em;">
            Files are quarantined instead of being immediately deleted. They can be restored if deleted by mistake.
            Files expire after 30 days and are permanently deleted.
          </p>

          <!-- Deep scan progress display -->
          <div id="deep-scan-progress" style="display: none; margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; border: 1px solid #333;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span id="deep-scan-status" style="color: #4a9eff; font-size: 0.85em; font-weight: 500;">Initializing...</span>
              <span id="deep-scan-counter" style="color: #888; font-size: 0.8em;">0 / 0</span>
            </div>
            <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
              <div id="deep-scan-bar" style="height: 100%; width: 0%; background: #4a9eff; border-radius: 3px; transition: width 0.15s ease;"></div>
            </div>
            <div id="deep-scan-folder" style="margin-top: 4px; color: #666; font-size: 0.75em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="">
              —
            </div>
            <div id="deep-scan-orphans" style="margin-top: 2px; color: #888; font-size: 0.75em;">
              Orphans found: 0
            </div>
            <div style="margin-top: 6px; text-align: right;">
              <button id="scan-cancel-btn" class="btn-small btn-danger" onclick="cancelDeepScan()" style="display: none;">Cancel Scan</button>
            </div>
          </div>

          <!-- Delete progress display -->
          <div id="delete-progress" style="display: none; margin-top: 10px; padding: 10px; background: #1a1a1a; border-radius: 4px; border: 1px solid #533;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
              <span id="delete-status" style="color: #f55; font-size: 0.85em; font-weight: 500;">Deleting files...</span>
              <span id="delete-counter" style="color: #888; font-size: 0.8em;">0 / 0</span>
            </div>
            <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
              <div id="delete-bar" style="height: 100%; width: 0%; background: #f55; border-radius: 3px; transition: width 0.15s ease;"></div>
            </div>
            <div style="margin-top: 6px; text-align: right;">
              <button id="delete-cancel-btn" class="btn-small btn-danger" onclick="cancelDelete()" style="display: none;">Cancel Delete</button>
            </div>
          </div>

          <p style="margin: 0; color: #666; font-size: 0.85em;" id="quarantine-scan-status">
            <strong>Scan (History):</strong> Detects orphans from recordings you processed. <strong>Deep Scan:</strong> Scans configured paths for all orphaned files.
          </p>
        </div>
        <div class="table-container">
          <table class="quarantine-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="quarantine-select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>File</th>
                <th>Type</th>
                <th>Size</th>
                <th>Quarantined</th>
                <th>Expires</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="quarantine-list">
              <tr>
                <td colspan="7" style="text-align: center; color: #888;">Loading quarantined files...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Channels Files Audit Tab (experimental, hidden unless enabled) -->
      <div id="channels-files-tab" class="tab-content">
        <div class="tab-header">
          <small class="muted" id="channels-files-stats">Experimental — cross-reference DVR API with filesystem</small>
          <div style="margin-left:auto; display:flex; gap:8px;">
            <button class="btn-small" id="audit-run-btn" onclick="runChannelsFilesAudit()">Run Audit</button>
            <button class="btn-small btn-danger" id="audit-cancel-btn" onclick="cancelChannelsFilesAudit()" style="display:none">Cancel</button>
          </div>
        </div>

        <!-- Audit progress display -->
        <div id="audit-progress" style="display: none; padding: 10px; margin-bottom: 10px; background: #2a2a2a; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <span id="audit-progress-status" style="color: #4a9eff; font-size: 0.85em; font-weight: 500;">Initializing...</span>
            <span id="audit-progress-counter" style="color: #888; font-size: 0.8em;"></span>
          </div>
          <div style="width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden;">
            <div id="audit-progress-bar" style="height: 100%; width: 0%; background: #4a9eff; border-radius: 3px; transition: width 0.15s ease;"></div>
          </div>
          <div id="audit-progress-detail" style="margin-top: 4px; color: #666; font-size: 0.75em;">—</div>
        </div>

        <!-- Audit results (shown after audit completes) -->
        <div id="audit-results" style="display: none;">
          <!-- Summary cards -->
          <div id="audit-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 15px;"></div>

          <!-- Missing files table -->
          <div id="audit-missing-section" style="display: none; margin-bottom: 15px;">
            <h3 style="margin: 0 0 8px 0; font-size: 0.95em; color: #f55;">Missing Files <span id="audit-missing-count" class="pill pill-muted">0</span></h3>
            <p style="margin: 0 0 8px 0; color: #888; font-size: 0.8em;">Files the API says exist, but are not found on disk.</p>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
              <table class="quarantine-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Path</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="audit-missing-list"></tbody>
              </table>
            </div>
          </div>

          <!-- Orphaned files table -->
          <div id="audit-orphaned-section" style="display: none; margin-bottom: 15px;">
            <h3 style="margin: 0 0 8px 0; font-size: 0.95em; color: #f90;">Orphaned Files <span id="audit-orphaned-count" class="pill pill-muted">0</span></h3>
            <p style="margin: 0 0 8px 0; color: #888; font-size: 0.8em;">Files on disk that are not tracked by the Channels DVR API.
              <label style="margin-left: 16px; cursor: pointer; user-select: none;">
                <input type="checkbox" id="audit-show-trash" checked onchange="filterAuditOrphans()" style="vertical-align: middle;">
                <span style="vertical-align: middle;">Show trashed files</span>
              </label>
            </p>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
              <table class="quarantine-table">
                <thead>
                  <tr>
                    <th style="width: 40px; text-align: center;">Trash</th>
                    <th>Filename</th>
                    <th>Path</th>
                    <th>Size</th>
                  </tr>
                </thead>
                <tbody id="audit-orphaned-list"></tbody>
              </table>
            </div>
          </div>

          <!-- Empty folders table -->
          <div id="audit-empty-section" style="display: none;">
            <h3 style="margin: 0 0 8px 0; font-size: 0.95em; color: #888;">Empty Folders <span id="audit-empty-count" class="pill pill-muted">0</span></h3>
            <p style="margin: 0 0 8px 0; color: #888; font-size: 0.8em;">Recording folders with no matching media files.</p>
            <div class="table-container" style="max-height: 200px; overflow-y: auto;">
              <table class="quarantine-table">
                <thead>
                  <tr><th>Folder Path</th></tr>
                </thead>
                <tbody id="audit-empty-list"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Placeholder when no audit has run -->
        <div id="audit-placeholder" style="padding: 40px; text-align: center; color: #666;">
          <p style="font-size: 1.1em; margin-bottom: 8px;">No audit results yet</p>
          <p style="font-size: 0.85em;">Click <strong>Run Audit</strong> to cross-reference the Channels DVR file database with the filesystem.</p>
        </div>
      </div>
    </section>

  </main>

  <!-- Modal for execution details -->
    <div id="exec-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Execution Details</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
          <p class="muted">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Modal for manual processing -->
    <div id="manual-process-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Manual Processing</h2>
          <button class="modal-close" onclick="closeManualProcessModal()">&times;</button>
        </div>
        <div class="modal-body">
           <div class="manual-process-controls">
             <p class="muted">Browse recordings from Channels DVR and select items to process:</p>
             <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
               <div class="settings-group">
                 <label for="manual-process-skip-caption">Skip Caption Generation</label>
                 <input type="checkbox" id="manual-process-skip-caption" name="skip_caption_generation">
               </div>
               <div class="settings-group">
                 <label for="manual-process-log-verbosity">Log Verbosity</label>
                 <select id="manual-process-log-verbosity" name="log_verbosity">
                   <option value="MINIMAL">Minimal</option>
                   <option value="NORMAL" selected>Normal</option>
                   <option value="VERBOSE">Verbose</option>
                 </select>
               </div>
             </div>
             <p class="muted" style="font-size: 0.9em; margin-top: -5px;">These settings will apply to all selected items.</p>
           </div>
          <div id="manual-process-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
            <p class="muted">Loading candidates...</p>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
            <button onclick="closeManualProcessModal()" class="btn-secondary">Cancel</button>
            <button onclick="submitManualProcessing()" class="btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for settings -->
    <div id="settings-modal" class="modal">
      <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
          <div style="display: flex; align-items: center; gap: 10px;">
            <h2>System Settings</h2>
            <span id="webui-version" class="pill pill-muted">v—</span>
          </div>
          <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- System Information Section -->
          <div style="background: var(--panel-bg); border: 1px solid var(--panel-border); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text); text-transform: uppercase; letter-spacing: 0.5px;">System Information</h3>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-size: 13px;">
              <span style="color: var(--muted); font-weight: 600;">Application:</span>
              <span id="app-name" style="color: var(--text);">—</span>
              
              <span style="color: var(--muted); font-weight: 600;">Version:</span>
              <span id="app-version" style="color: var(--text);">—</span>
              
              <span style="color: var(--muted); font-weight: 600;">Server Timezone:</span>
              <span id="timezone" style="color: var(--text);">—</span>
              
              <span style="color: var(--muted); font-weight: 600;">Last Processed:</span>
              <span id="last-processed" style="color: var(--text);">—</span>
              
              <span style="color: var(--muted); font-weight: 600;">Manual Queue:</span>
              <span id="modal-queue-size" style="color: var(--text);">—</span>
            </div>
          </div>

          <!-- Info Notice -->
          <div style="background: #d1ecf1; border: 1px solid #0c5460; padding: 12px; border-radius: 6px; margin-bottom: 20px; color: #0c5460;">
            <strong>ℹ️ Note:</strong> Changes to settings will require restarting the application to take effect.
          </div>

          <form id="settings-form" onsubmit="saveEnvSettings(event)">
            <!-- Settings will be dynamically loaded here -->
            <div id="settings-container">
              <p style="text-align: center; color: var(--muted);">Loading settings...</p>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; border-top: 1px solid var(--panel-border); padding-top: 20px;">
              <button type="button" class="btn-secondary" onclick="closeSettingsModal()">Cancel</button>
              <button type="submit" class="btn-primary">Save to .env</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  <script src="/static/vendor/uplot.min.js"></script>
  <script src="/static/main.js?v=1772200000"></script>
</body>
</html>
